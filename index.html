<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Forecast - Dreamy Pastel Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        :root {
            --bg-dark: #1A1B26;
            --primary-glow: #C792EA;
            --secondary-glow: #89DDFF;
            --tertiary-glow: #FFCB6B;
            --text-light: #E0E7FF;
            --text-muted: #A6ACCD;
            --panel-bg: rgba(137, 221, 255, 0.08);
            --panel-border: rgba(199, 146, 234, 0.3);
            --font-display: 'Montserrat', sans-serif;
            --font-mono: 'Roboto', sans-serif;
            --border-radius-lg: 15px;
            --border-radius-sm: 5px;
            --grid-pattern: linear-gradient(0deg, transparent 24%, var(--panel-border) 25%, var(--panel-border) 26%, transparent 27%, transparent 74%, var(--panel-border) 75%, var(--panel-border) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, var(--panel-border) 25%, var(--panel-border) 26%, transparent 27%, transparent 74%, var(--panel-border) 75%, var(--panel-border) 76%, transparent 77%, transparent);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-mono);
            background-color: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background-image: radial-gradient(circle at center, rgba(199, 146, 234, 0.1) 0%, transparent 70%);
            animation: pulse-bg 15s infinite alternate;
        }
        @keyframes pulse-bg { 0% { background-size: 100% 100%; } 100% { background-size: 150% 150%; } }
        .container { width: 100%; max-width: 1200px; padding: 40px 20px; position: relative; z-index: 10; }
        .header { text-align: center; margin-bottom: 40px; text-shadow: 0 0 10px var(--primary-glow); }
        .logo { width: 120px; height: auto; margin: 0 auto 20px; display: block; filter: drop-shadow(0 0 10px var(--primary-glow)); animation: pulse-logo 3s infinite alternate; }
        .logo img { width: 100%; height: auto; display: block; }
        @keyframes pulse-logo { 0% { transform: scale(1); filter: drop-shadow(0 0 10px var(--primary-glow)); } 100% { transform: scale(1.05); filter: drop-shadow(0 0 20px var(--primary-glow)); } }
        h1 { font-family: var(--font-display); font-size: clamp(2.2em, 5vw, 3em); margin-bottom: 8px; }
        .subtitle { color: var(--text-muted); font-size: 1em; }
        .panel, .results-panel > * { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: var(--border-radius-lg); padding: 30px; margin-bottom: 25px; box-shadow: 0 0 20px rgba(199, 146, 234, 0.1); position: relative; overflow: hidden; opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .panel::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: var(--grid-pattern); background-size: 50px 50px; opacity: 0.1; z-index: 0; pointer-events: none; }
        .panel > *:not(.glitch-effect) { position: relative; z-index: 1; }
        .panel.is-visible, .results-panel > *.is-visible { opacity: 1; transform: translateY(0); }
        .input-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .input-group label { display: block; font-family: var(--font-mono); font-size: 0.9em; color: var(--primary-glow); margin-bottom: 8px; text-shadow: 0 0 5px var(--primary-glow); }
        .input-group input, .input-group select { width: 100%; padding: 12px; background: rgba(137, 221, 255, 0.1); border: 1px solid var(--panel-border); border-radius: var(--border-radius-sm); font-size: 1rem; color: var(--text-light); font-family: var(--font-mono); box-shadow: inset 0 0 5px rgba(199, 146, 234, 0.5); transition: all 0.2s ease; }
        .input-group select option { background: var(--bg-dark); color: var(--text-light); }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--secondary-glow); box-shadow: 0 0 10px var(--secondary-glow), inset 0 0 5px var(--secondary-glow); }
        .predict-btn { width: 100%; padding: 14px; font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; color: var(--bg-dark); background: var(--primary-glow); border: none; border-radius: var(--border-radius-sm); cursor: pointer; box-shadow: 0 0 15px var(--primary-glow); transition: all 0.2s ease; position: relative; overflow: hidden; }
        .predict-btn:hover { background: var(--secondary-glow); color: var(--bg-dark); box-shadow: 0 0 20px var(--secondary-glow); transform: translateY(-2px); }
        .predict-btn:active { transform: translateY(0); }
        .glitch-effect { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--tertiary-glow); opacity: 0; clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); }
        .predict-btn.active .glitch-effect { animation: glitch-anim 0.3s forwards; }
        @keyframes glitch-anim { 0% { opacity: 0; transform: scale(1); } 20% { opacity: 0.8; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1); } }
        .results-panel h2, .results-panel h3 { font-family: var(--font-display); text-align: center; margin-bottom: 20px; text-shadow: 0 0 8px var(--primary-glow); color: var(--primary-glow); }
        .results-panel p { color: var(--text-light); }
        .weather-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .weather-card { text-align: center; padding: 20px; border: 1px solid var(--panel-border); border-radius: var(--border-radius-sm); background: var(--panel-bg); }
        .weather-title { font-size: 0.8em; color: var(--text-muted); margin-bottom: 5px; }
        .weather-value { font-size: 1.8em; font-family: var(--font-display); color: var(--secondary-glow); text-shadow: 0 0 5px var(--secondary-glow); }
        .holographic-meter { width: 150px; height: 150px; border-radius: 50%; border: 2px solid var(--primary-glow); background: radial-gradient(circle at center, rgba(199, 146, 234, 0.1) 0%, rgba(199, 146, 234, 0.02) 70%); margin: 20px auto; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px var(--primary-glow); overflow: hidden; }
        .meter-fill-arc { position: absolute; width: 100%; height: 100%; clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%); background: linear-gradient(45deg, var(--secondary-glow), var(--primary-glow)); transform-origin: 50% 50%; transform: rotate(-180deg); transition: transform 2s ease-out; }
        .meter-center-dot { width: 20px; height: 20px; border-radius: 50%; background: var(--text-light); box-shadow: 0 0 10px var(--text-light); position: relative; z-index: 2; }
        .meter-label { position: absolute; font-family: var(--font-mono); font-size: 0.8em; color: var(--text-light); text-shadow: 0 0 5px var(--text-light); }
        .forecast-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center; margin-top: 20px; }
        .forecast-card { padding: 15px; border: 1px solid var(--panel-border); border-radius: var(--border-radius-sm); background: var(--panel-bg); }
        .forecast-day { font-family: var(--font-display); font-size: 0.9em; color: var(--primary-glow); }
        .forecast-icon { font-size: 2em; margin: 5px 0; text-shadow: 0 0 8px var(--secondary-glow); }
        .forecast-temp { font-size: 1.1em; color: var(--text-light); }
        .chart-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--panel-border); }
        .chart-tab { padding: 10px 15px; background: transparent; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-family: var(--font-mono); font-weight: 500; font-size: 0.9em; color: var(--text-muted); transition: all 0.2s; text-shadow: 0 0 5px transparent; }
        .chart-tab.active, .chart-tab:hover { color: var(--primary-glow); border-bottom-color: var(--primary-glow); text-shadow: 0 0 8px var(--primary-glow); }
        .historical-chart { display: none; padding-top: 20px; min-height: 250px; }
        .historical-chart.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chart-svg .line { stroke: var(--secondary-glow); stroke-width: 2; fill: none; }
        .chart-svg .area { fill: var(--primary-glow); opacity: 0.1; }
        .chart-svg .point { fill: var(--primary-glow); stroke: var(--bg-dark); stroke-width: 1; r: 4; cursor: pointer; transition: r 0.2s ease; }
        .chart-svg .point:hover { r: 7; }
        .svg-tooltip { position: absolute; background: var(--bg-dark); color: var(--text-light); padding: 5px 10px; border-radius: 4px; border: 1px solid var(--panel-border); font-size: 0.8em; opacity: 0; pointer-events: none; transition: opacity 0.2s; transform: translate(-50%, -150%); z-index: 100; }
        .chart-svg text { fill: var(--text-muted); font-family: var(--font-mono); font-size: 10px; }
        .precipitation-bars-container { display: flex; align-items: flex-end; height: 200px; gap: 8px; padding: 0 10px; }
        .precip-bar-item { flex: 1; background: linear-gradient(to top, var(--secondary-glow), transparent); border-radius: 4px 4px 0 0; position: relative; animation: growBar 1s ease-out; }
        @keyframes growBar { from { height: 0; } }
        .heatmap-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; height: 220px; padding: 10px; }
        .heatmap-cell { border-radius: 4px; transition: background-color 0.5s ease; animation: fadeInCell 0.5s ease-out forwards; }
        @keyframes fadeInCell { from { opacity: 0; } to { opacity: 1; } }
        .wind-compass-container { width: 200px; height: 200px; border-radius: 50%; border: 2px solid var(--primary-glow); background: radial-gradient(circle at center, rgba(199, 146, 234, 0.1) 0%, transparent 70%); margin: 20px auto; position: relative; box-shadow: 0 0 15px var(--primary-glow); display: flex; align-items: center; justify-content: center; }
        .compass-arrow { width: 3px; background: var(--secondary-glow); position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; border-radius: 2px; margin-left: -1.5px; box-shadow: 0 0 8px var(--secondary-glow); transition: transform 1s ease-out; animation: expandArrow 0.5s ease-out forwards; }
        @keyframes expandArrow { 0% { height: 0; } 100% { height: var(--arrow-height); } }
        .compass-dot { width: 15px; height: 15px; border-radius: 50%; background: var(--text-light); box-shadow: 0 0 8px var(--text-light); z-index: 2; }
        .compass-dir-label { position: absolute; font-family: var(--font-display); font-size: 0.9em; color: var(--primary-glow); text-shadow: 0 0 5px var(--primary-glow); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; text-align: center; }
        .stat-card { padding: 20px; border: 1px solid var(--panel-border); border-radius: var(--border-radius-sm); background: var(--panel-bg); }
        .stat-number { font-size: 2em; font-family: var(--font-display); color: var(--tertiary-glow); text-shadow: 0 0 8px var(--tertiary-glow); }
        .stat-label { font-size: 0.8em; color: var(--text-muted); }
        .download-btn { display: block; width: 100%; text-align: center; padding: 12px; font-family: var(--font-display); font-weight: 600; font-size: 1rem; color: var(--bg-dark); background: var(--secondary-glow); border: none; border-radius: var(--border-radius-sm); text-decoration: none; box-shadow: 0 0 15px var(--secondary-glow); transition: all 0.2s ease; }
        .download-btn:hover { background: var(--primary-glow); box-shadow: 0 0 20px var(--primary-glow); transform: translateY(-2px); }
        .terminal-loading { font-family: var(--font-mono); color: var(--secondary-glow); text-shadow: 0 0 5px var(--secondary-glow); animation: terminal-blink 1s infinite; }
        @keyframes terminal-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @media (max-width: 768px) { .input-section { grid-template-columns: 1fr; } .forecast-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));} }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/NASA_logo.svg" alt="NASA Logo">
            </div>
            <h1>WILL IT RAIN ON MY PARADE?</h1>
            <p class="subtitle">Planning your Earth-side mission? Let's check the skies!</p>
        </header>
        <section class="panel">
            <div class="input-section">
                <div class="input-group">
                   <label for="location">MISSION LOCATION <span style="color:var(--tertiary-glow);">[REQUIRED]</span></label>
                   <input type="text" id="location" placeholder="e.g., Cape Canaveral, Mumbai">
               </div>
               <div class="input-group">
                   <label for="date">MISSION DATE <span style="color:var(--tertiary-glow);">[REQUIRED]</span></label>
                   <input type="date" id="date">
               </div>
               <div class="input-group">
                   <label for="event">ACTIVITY PROFILE <span style="color:var(--text-muted);">[OPTIONAL]</span></label>
                   <select id="event">
                       <option value="">SELECT ACTIVITY...</option>
                       <option value="parade">PARADE / LAUNCH</option>
                       <option value="wedding">CEREMONIAL EVENT</option>
                       <option value="hiking">FIELD EXCURSION</option>
                       <option value="picnic">LEISURE OUTING</option>
                   </select>
               </div>
               <div class="input-group">
                   <label for="sensitivity">WEATHER SENSITIVITY <span style="color:var(--text-muted);">[OPTIONAL]</span></label>
                   <select id="sensitivity">
                       <option value="low">HIGH TOLERANCE (ROBUST)</option>
                       <option value="medium" selected>MEDIUM TOLERANCE (STANDARD)</option>
                       <option value="high">LOW TOLERANCE (CRITICAL)</option>
                   </select>
               </div>
           </div>
           <button class="predict-btn" onclick="predictWeather()">
               INITIATE FORECAST <div class="glitch-effect"></div>
           </button>
           <div id="map" style="width:100%;height:300px;margin-top:20px;border-radius:10px;overflow:hidden;"></div>
       </section>
        <section class="results-panel" id="results-panel"></section>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('is-visible'); observer.unobserve(entry.target); } });
        }, { threshold: 0.1 });
        function countUp(element, end, duration = 1000) { if (!element) return; let start = 0; const range = end - start; let current = start; const increment = end > start ? 1 : -1; const stepTime = Math.abs(Math.floor(duration / range)); const timer = setInterval(() => { current += increment; element.textContent = Math.round(current); if (current == end) { clearInterval(timer); element.textContent = end; } }, stepTime < 1 ? 1 : stepTime); }
        function reapplyInteractivity() { document.querySelectorAll('.results-panel > *, .panel').forEach(el => observer.observe(el)); }
        const API_KEY = '7c4e6b96a7c68d700c0557cee63742b8';
        const BASE_URL = 'https://api.openweathermap.org/data/2.5';
        let fullWeatherData = null;
        let map, marker;

        function initMap() {
            if (map) return;
            map = L.map('map').setView([20, 0], 2); // Default world view
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        async function updateMapForLocation(location) {
            if (!location) return;
            try {
                const coords = await getCoordinates(location);
                if (!map) initMap();
                map.setView([coords.lat, coords.lon], 10);
                if (marker) marker.setLatLng([coords.lat, coords.lon]);
                else marker = L.marker([coords.lat, coords.lon]).addTo(map)
                    .bindPopup(`${coords.city}, ${coords.country}`).openPopup();
                marker.setPopupContent(`${coords.city}, ${coords.country}`);
            } catch (e) {
                // Optionally show error on map
            }
        }

        async function predictWeather() {
            const location = document.getElementById('location').value.trim();
            if (!location) { alert('[NASA] WARNING: MISSION LOCATION REQUIRED. FORECAST ABORTED.'); return; }
            const predictBtn = document.querySelector('.predict-btn');
            predictBtn.classList.add('active'); setTimeout(() => predictBtn.classList.remove('active'), 300);
            const resultsPanel = document.getElementById('results-panel');
            resultsPanel.innerHTML = `<div class="loading is-visible panel" style="text-align:center;"><p class="terminal-loading">ENGAGING SATELLITE LINK_</p></div>`;
            reapplyInteractivity();
            try {
                const coords = await getCoordinates(location);
                const [weather, forecast] = await Promise.all([ getCurrentWeather(coords.lat, coords.lon), getForecast(coords.lat, coords.lon) ]);
                fullWeatherData = { weather, forecast, coords };
                displayAllFeatures(weather, forecast, coords);
            } catch (error) {
                resultsPanel.innerHTML = `<div class="error is-visible panel" style="text-align:center; color: var(--tertiary-glow);"><h3>[NASA] CRITICAL FAILURE: WEATHER DATA UNAVAILABLE.</h3><p>${error.message}</p></div>`;
                reapplyInteractivity();
            }
        }
        function displayAllFeatures(weather, forecast, coords) {
            const resultsPanel = document.getElementById('results-panel');
            const event = document.getElementById('event').value;
            const sensitivity = document.getElementById('sensitivity').value;
            const successProb = calculateSuccessProbability(weather, forecast, event, sensitivity);
            resultsPanel.innerHTML = `
                <h2>[ ${coords.city.toUpperCase()} ] MISSION WEATHER BRIEF</h2>
                <div class="panel weather-cards">${getWeatherCardsHTML(weather, forecast)}</div>
                <div class="panel">
                    <h3>PARADE SUCCESS PROBABILITY</h3>
                    <div class="holographic-meter">
                        <div class="meter-fill-arc" id="holographicMeterFill"></div>
                        <div class="meter-center-dot"></div>
                        <div class="meter-label" style="top: 5px; left: 50%; transform: translateX(-50%);">100%</div>
                        <div class="meter-label" style="bottom: 5px; left: 50%; transform: translateX(-50%);">0%</div>
                        <div class="meter-label" style="left: 5px; top: 50%; transform: translateY(-50%) rotate(90deg);">LOW</div>
                        <div class="meter-label" style="right: 5px; top: 50%; transform: translateY(-50%) rotate(-90deg);">HIGH</div>
                    </div>
                    <p style="text-align:center; margin-top:15px;">CALCULATED PROBABILITY: <span id="successProbDisplay" class="weather-value" style="font-size:1.5em;">0</span>%</p>
                </div>
                <div class="panel">
                    <h3>5-DAY FORECAST OVERVIEW</h3>
                    <div class="forecast-grid">${getForecastGridHTML(forecast)}</div>
                </div>
                <div class="panel chart-container">
                    <h3>HISTORICAL WEATHER ANALYSIS</h3>
                    <div class="chart-tabs">
                        <button class="chart-tab active" onclick="showChart(event, 'temperatureChart')">TEMPERATURE</button>
                        <button class="chart-tab" onclick="showChart(event, 'precipitationChart')">PRECIPITATION</button>
                        <button class="chart-tab" onclick="showChart(event, 'patternsChart')">WEATHER PATTERNS</button>
                        <button class="chart-tab" onclick="showChart(event, 'windChart')">WIND CONDITIONS</button>
                    </div>
                    <div class="chart-content">
                        <div class="historical-chart active" id="temperatureChart"></div>
                        <div class="historical-chart" id="precipitationChart"></div>
                        <div class="historical-chart" id="patternsChart"></div>
                        <div class="historical-chart" id="windChart"></div>
                    </div>
                </div>
                <div class="panel">
                    <h3>ARCHIVED CLIMATE STATISTICS</h3>
                    <div class="stats-grid">${getHistoricalStatsHTML(weather)}</div>
                </div>
                <a href="#" class="download-btn" onclick="event.preventDefault(); downloadData();">DOWNLOAD MISSION LOGS</a>
            `;
            setTimeout(() => {
                document.querySelectorAll('[data-count]').forEach(el => { countUp(el, parseInt(el.dataset.count)); });
                countUp(document.getElementById('successProbDisplay'), successProb);
                const meterFill = document.getElementById('holographicMeterFill');
                const rotation = (successProb / 100) * 180 - 180;
                if(meterFill) meterFill.style.transform = `rotate(${rotation}deg)`;
                generateTemperatureChart(forecast);
                generatePrecipitationChart(forecast);
                generateWeatherHeatmap(forecast);
                generateWindCompass(weather.wind);
            }, 100);
            reapplyInteractivity();
        }
        function getWeatherCardsHTML(weather, forecast) {
            const rainProb = calculateRainProbability(weather, forecast);
            return `
                <div class="weather-card"><div class="weather-title">TEMPERATURE</div><div class="weather-value"><span data-count="${Math.round(weather.main.temp)}">0</span>°C</div></div>
                <div class="weather-card"><div class="weather-title">PRECIPITATION PROB</div><div class="weather-value"><span data-count="${rainProb}">0</span>%</div></div>
                <div class="weather-card"><div class="weather-title">WIND VELOCITY</div><div class="weather-value"><span data-count="${Math.round(weather.wind.speed*3.6)}">0</span><span style="font-size:0.6em">km/h</span></div></div>
                <div class="weather-card"><div class="weather-title">HUMIDITY</div><div class="weather-value"><span data-count="${weather.main.humidity}">0</span>%</div></div>
                <div class="weather-card"><div class="weather-title">CONDITION</div><div class="weather-value" style="font-size:1.2em;font-weight:600;">${weather.weather[0].main.toUpperCase()}</div></div>`;
        }
        function getForecastGridHTML(forecast) {
            const daily = {}; forecast.list.slice(0, 40).forEach(i=>{ const d=new Date(i.dt*1000).toDateString();if(!daily[d])daily[d]={t:[],i:i.weather[0].icon};daily[d].t.push(i.main.temp)});
            return Object.entries(daily).slice(0,5).map(([d,day])=>{
                const dt=new Date(d); const n=dt.toLocaleDateString('en',{weekday:'short'}); const min=Math.round(Math.min(...day.t)); const max=Math.round(Math.max(...day.t));
                return `<div class="forecast-card"><div class="forecast-day">${n.toUpperCase()}</div><div class="forecast-icon">${getWeatherEmoji(day.i)}</div><div class="forecast-temp">${max}°/${min}°</div></div>`;
            }).join('');
        }
        function getHistoricalStatsHTML(weather) {
            return `
                <div class="stat-card"><div class="stat-label">AVG TEMP (ARCHIVED)</div><div class="stat-number"><span data-count="${Math.round(weather.main.temp - 2)}">0</span>°C</div></div>
                <div class="stat-card"><div class="stat-label">AVG RAINY PERIODS/CYCLE</div><div class="stat-number">~<span data-count="8">0</span></div></div>
                <div class="stat-card"><div class="stat-label">MAX WIND RECORDED</div><div class="stat-number">~<span data-count="65">0</span> km/h</div></div>`;
        }
        function downloadData() { if(!fullWeatherData){alert('[NASA] WARNING: NO DATA TO DOWNLOAD.');return} alert('[NASA] DOWNLOAD INITIATED: Transferring mission logs...'); console.log(fullWeatherData); }
        function showChart(e, chartId) { const container = e.target.closest('.chart-container'); container.querySelectorAll('.chart-tab').forEach(t=>t.classList.remove('active')); e.target.classList.add('active'); container.querySelectorAll('.historical-chart').forEach(c=>c.classList.remove('active')); document.getElementById(chartId).classList.add('active'); }
        function generateTemperatureChart(forecastData) {
            const container = document.getElementById('temperatureChart'); if (!container) return; container.innerHTML = '';
            const pointsData = forecastData.list.slice(0, 8).map(item=>({temp:Math.round(item.main.temp), time:new Date(item.dt*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}));
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg"); svg.setAttribute('class', 'chart-svg'); svg.setAttribute('viewBox', `0 0 500 200`);
            const temps = pointsData.map(p=>p.temp); const minTemp = Math.min(...temps); const maxTemp = Math.max(...temps); const padding=30;
            const getX=(i)=>(i/(pointsData.length-1))*(500-2*padding)+padding; const getY=(temp)=>200-padding-((temp-minTemp)/(maxTemp-minTemp+0.1))*(200-2*padding);
            let pathData="M"; let areaData="M";
            pointsData.forEach((p,i)=>{const x=getX(i);const y=getY(p.temp);pathData+=` ${x},${y}`;areaData+=` ${x},${y}`;});
            areaData += ` L${getX(pointsData.length-1)},${200-padding} L${getX(0)},${200-padding}Z`;
            svg.innerHTML = `<path class="area" d="${areaData}"></path><path class="line" d="${pathData}"></path>`;
            pointsData.forEach((p,i)=>{if(i%2==0){const text=document.createElementNS("http://www.w3.org/2000/svg","text");text.setAttribute('x',getX(i));text.setAttribute('y',200-padding+15);text.setAttribute('text-anchor','middle');text.textContent=p.time;svg.appendChild(text)}});
            container.appendChild(svg);
            const line = svg.querySelector('.line'); const length = line.getTotalLength(); line.style.strokeDasharray = length; line.style.strokeDashoffset = length; setTimeout(() => { line.style.transition = 'stroke-dashoffset 2s ease-out'; line.style.strokeDashoffset = '0'; }, 100);
        }
        function generatePrecipitationChart(forecastData) {
            const container = document.getElementById('precipitationChart'); if (!container) return; container.innerHTML = '';
            const precipData = forecastData.list.slice(0, 8).map(item => ({
                rain: item.rain && item.rain['3h'] ? item.rain['3h'] : 0,
                time: new Date(item.dt * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            }));
            const maxRain = Math.max(...precipData.map(d => d.rain), 2);
            const barContainer = document.createElement('div'); barContainer.className = 'precipitation-bars-container';
            precipData.forEach((data, i) => {
                const barHeight = (data.rain / maxRain) * 100;
                const barItem = document.createElement('div');
                barItem.className = 'precip-bar-item';
                barItem.style.height = `${barHeight}%`;
                barItem.style.position = 'relative';
                // Value label
                const valueLabel = document.createElement('div');
                valueLabel.style.position = 'absolute';
                valueLabel.style.bottom = '100%';
                valueLabel.style.left = '50%';
                valueLabel.style.transform = 'translateX(-50%)';
                valueLabel.style.fontSize = '0.9em';
                valueLabel.style.color = 'var(--text-light)';
                valueLabel.textContent = `${data.rain.toFixed(1)}mm`;
                barItem.appendChild(valueLabel);
                // Time label
                const timeLabel = document.createElement('div');
                timeLabel.style.position = 'absolute';
                timeLabel.style.top = '100%';
                timeLabel.style.left = '50%';
                timeLabel.style.transform = 'translateX(-50%)';
                timeLabel.style.fontSize = '0.85em';
                timeLabel.style.color = 'var(--text-muted)';
                timeLabel.textContent = data.time;
                barItem.appendChild(timeLabel);
                barContainer.appendChild(barItem);
            });
            // Y-axis label
            const yAxis = document.createElement('div');
            yAxis.style.position = 'absolute';
            yAxis.style.left = '0';
            yAxis.style.top = '10px';
            yAxis.style.fontSize = '0.85em';
            yAxis.style.color = 'var(--text-muted)';
            yAxis.textContent = `Max: ${maxRain.toFixed(1)}mm`;
            container.style.position = 'relative';
            container.appendChild(barContainer);
            container.appendChild(yAxis);
        }
        function generateWeatherHeatmap(forecastData) {
            const container = document.getElementById('patternsChart'); if (!container) return; container.innerHTML = '';
            const heatmapGrid = document.createElement('div'); heatmapGrid.className = 'heatmap-grid';
            Array.from({ length: 5 * 8 }).forEach((_, i) => {
                const item = forecastData.list[i] || { weather: [{ id: 800, main: 'Clear', icon: '01d' }], dt: Date.now() / 1000 };
                let severity = (804 - item.weather[0].id) / 600;
                const cell = document.createElement('div'); cell.className = 'heatmap-cell';
                cell.style.backgroundColor = `rgba(137, 221, 255, ${0.1 + severity * 0.8})`;
                cell.style.animationDelay = `${i * 0.02}s`;
                // Tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'svg-tooltip';
                tooltip.style.opacity = 0;
                tooltip.style.position = 'fixed';
                tooltip.innerHTML = `<b>${item.weather[0].main}</b> ${getWeatherEmoji(item.weather[0].icon)}<br>${new Date(item.dt * 1000).toLocaleString([], { weekday: 'short', hour: '2-digit', minute: '2-digit' })}`;
                cell.addEventListener('mouseenter', (e) => {
                    tooltip.style.opacity = 1;
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY - 30) + 'px';
                    document.body.appendChild(tooltip);
                });
                cell.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY - 30) + 'px';
                });
                cell.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = 0;
                    if (tooltip.parentNode) tooltip.parentNode.removeChild(tooltip);
                });
                heatmapGrid.appendChild(cell);
            });
            container.appendChild(heatmapGrid);
        }
        function generateWindCompass(windData) {
            const container = document.getElementById('windChart'); if (!container) return; container.innerHTML = '';
            const compass = document.createElement('div'); compass.className = 'wind-compass-container';
            const directions = ['N','E','S','W']; const angles = [0,90,180,270];
            directions.forEach((dir, i) => {
                const label = document.createElement('div'); label.className = 'compass-dir-label';
                const radius = 90; const rad = (angles[i] - 90) * (Math.PI / 180);
                label.style.top = `${50 + radius * Math.sin(rad)}%`; label.style.left = `${50 + radius * Math.cos(rad)}%`;
                label.style.transform = `translate(-50%, -50%)`; label.textContent = dir;
                compass.appendChild(label);
});
            const windArrow = document.createElement('div'); windArrow.className = 'compass-arrow'; const windRotation = windData.deg; const arrowHeight = Math.min(80, 20 + windData.speed * 5);
            windArrow.style.setProperty('--arrow-height', `${arrowHeight}px`); windArrow.style.transform = `rotate(${windRotation}deg)`;
            compass.appendChild(windArrow);
            const centerDot = document.createElement('div'); centerDot.className = 'compass-dot';
            compass.appendChild(centerDot);
            container.appendChild(compass);
        }
        async function getCoordinates(c){const r=await fetch(`${BASE_URL}/weather?q=${encodeURIComponent(c)}&appid=${API_KEY}&units=metric`);if(!r.ok)throw Error(`[NASA] ALERT: LOCATION DATA UNAVAILABLE FOR: ${c}`);const d=await r.json();return{lat:d.coord.lat,lon:d.coord.lon,city:d.name,country:d.sys.country}}
        async function getCurrentWeather(lat,lon){const r=await fetch(`${BASE_URL}/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`);if(!r.ok)throw Error('[NASA] ALERT: LOCAL WEATHER READINGS OFFLINE.');return r.json()}
        async function getForecast(lat,lon){const r=await fetch(`${BASE_URL}/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`);if(!r.ok)throw Error('[NASA] ALERT: PREDICTIVE MODEL OFFLINE.');return r.json()}
        function calculateRainProbability(w,f){let p=0;const m=w.weather[0].main.toLowerCase();if(m.includes('rain'))p+=60;else if(m.includes('drizzle'))p+=40;else if(m.includes('clouds'))p+=20;if(w.main.humidity>80)p+=15;if(f&&f.list){f.list.slice(0,2).forEach(fc=>{if(fc.weather[0].main.toLowerCase().includes('rain'))p+=20})}return Math.min(p,95)}
        function calculateSuccessProbability(w,f,e,s){let p=100;const r=calculateRainProbability(w,f);const t=w.main.temp;p-=r*0.8;if(t<5||t>35)p-=20;const sm={'low':0.5,'medium':1,'high':1.5};const ni=(100-p)*(sm[s]||1);return Math.max(0,100-ni)}
        function getWeatherEmoji(i){const m={'01d':'☀️','01n':'🌙','02d':'⛅','02n':'☁️','03d':'☁️','03n':'☁️','04d':'☁️','04n':'☁️','09d':'🌧️','09n':'🌧️','10d':'🌦️','10n':'🌦️','11d':'⛈️','11n':'⛈️','13d':'❄️','13n':'❄️','50d':'🌫️','50n':'🌫️'};return m[i]||'✨'}
        document.addEventListener('DOMContentLoaded', () => {
    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); document.getElementById('date').valueAsDate = tomorrow;
    reapplyInteractivity();
    initMap(); // <-- Add this line
});
document.getElementById('location').addEventListener('change', (e) => {
    updateMapForLocation(e.target.value.trim());
});
    </script>
</body>
</html>